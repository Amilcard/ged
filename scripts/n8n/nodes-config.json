{
  "meta": {
    "version": "1.0.0",
    "project": "GED - Groupe & Découverte",
    "workflow": "Grattoir UFOVAL - Production GED",
    "workflowId": "SqjOjFYjQfc9y2PD",
    "description": "4 nœuds n8n pour l'écriture automatique dans Supabase (gd_stays + gd_stay_sessions)",
    "date": "2026-01-30",
    "supabase": {
      "project": "iirfvndgzutbxwfdwawu",
      "host": "https://iirfvndgzutbxwfdwawu.supabase.co",
      "tables": ["gd_stays", "gd_stay_sessions"]
    }
  },
  "nodes": [
    {
      "order": 1,
      "name": "FILTER__VALID_ITEMS_FOR_DB",
      "type": "n8n-nodes-base.if",
      "displayName": "FILTER - Items valides pour DB",
      "position": [800, 300],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.source_url }}",
              "rightValue": "",
              "operation": "isNotEmpty"
            },
            {
              "leftValue": "={{ $json.pro?.title_pro }}",
              "rightValue": "",
              "operation": "isNotEmpty"
            },
            {
              "leftValue": "={{ $json.kids?.title_kids }}",
              "rightValue": "",
              "operation": "isNotEmpty"
            },
            {
              "leftValue": "={{ $json.sessions_json }}",
              "rightValue": "",
              "operation": "isNotEmpty"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "notesInFlow": true,
      "notes": "Filtre les items avec tous les champs obligatoires présents.\n\nConditions (AND) :\n- source_url not empty\n- pro.title_pro not empty\n- kids.title_kids not empty\n- sessions_json not empty\n\nSortie TRUE → Continue vers DB upsert\nSortie FALSE → Terminer (skip)"
    },
    {
      "order": 2,
      "name": "HTTP__UPSERT_GD_STAYS",
      "type": "n8n-nodes-base.httpRequest",
      "displayName": "HTTP - Upsert gd_stays",
      "position": [1000, 300],
      "parameters": {
        "method": "POST",
        "url": "={{ $credentials.supabase?.host || 'https://iirfvndgzutbxwfdwawu.supabase.co' }}/rest/v1/gd_stays",
        "authentication": "genericCredentialType",
        "genericAuthType": "supabaseApi",
        "sendBody": true,
        "bodyParameters": {
          "parameters": []
        },
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $credentials.supabase?.serviceRoleKey || $credentials.Supabase?.serviceRoleKey }}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{ $credentials.supabase?.serviceRoleKey || $credentials.Supabase?.serviceRoleKey }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "resolution=merge-duplicates,return=representation"
            }
          ]
        },
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "on_conflict",
              "value": "source_url"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $input.all().map(item => ({\n  source_url: item.json.source_url,\n  slug: item.json.slug || item.json.source_url.split('/').pop().replace(/[^a-z0-9-]/gi, '-').toLowerCase(),\n  title: item.json.pro?.title_pro || item.json.kids?.title_kids || 'Sans titre',\n  title_pro: item.json.pro?.title_pro,\n  title_kids: item.json.kids?.title_kids,\n  description_pro: item.json.pro?.description_pro || null,\n  description_kids: item.json.kids?.description_kids || null,\n  sessions_json: typeof item.json.sessions_json === 'string' ? item.json.sessions_json : JSON.stringify(item.json.sessions_json),\n  published: true,\n  import_batch_ts: new Date().toISOString()\n})) }}",
        "options": {}
      },
      "notesInFlow": true,
      "notes": "Upsert des séjours dans Supabase table gd_stays.\n\n- on_conflict=source_url (upsert, pas de doublons)\n- Header Prefer: merge-duplicates (update si existe)\n- Body: Array de stays avec tous les champs\n\nIMPORTANT: Adapter le credential Supabase dans l'authentification"
    },
    {
      "order": 3,
      "name": "TRANSFORM__SESSIONS_TO_ROWS",
      "type": "n8n-nodes-base.code",
      "displayName": "CODE - Transform sessions → rows",
      "position": [1200, 300],
      "parameters": {
        "language": "javaScript",
        "jsCode": "// Transformation sessions_json → lignes DB\n// Input: stays avec sessions_json (string ou array)\n// Output: N items (1 par session)\n\nconst output = [];\n\nfor (const item of $input.all()) {\n  const stay = item.json;\n\n  // Parse sessions_json (peut être string ou array ou object)\n  let sessions = [];\n  try {\n    if (Array.isArray(stay.sessions_json)) {\n      sessions = stay.sessions_json;\n    } else if (typeof stay.sessions_json === 'string') {\n      sessions = JSON.parse(stay.sessions_json);\n    } else if (stay.sessions_json && typeof stay.sessions_json === 'object') {\n      sessions = [stay.sessions_json];\n    }\n  } catch (e) {\n    console.error(`[TRANSFORM] Failed to parse sessions_json for stay ${stay.slug}:`, e);\n    continue; // Skip cet item\n  }\n\n  // Générer le slug si manquant\n  const staySlug = stay.slug || (stay.source_url ?\n    stay.source_url.split('/').pop().replace(/[^a-z0-9-]/gi, '-').toLowerCase() :\n    null\n  );\n\n  if (!staySlug) {\n    console.error('[TRANSFORM] Missing slug and source_url for stay:', stay);\n    continue;\n  }\n\n  // Créer une ligne par session\n  for (const session of sessions) {\n    // Vérifier que start_date et end_date existent\n    const startDate = session.start_date || session.date_debut || session.dateDebut || null;\n    const endDate = session.end_date || session.date_fin || session.dateFin || null;\n\n    if (!startDate || !endDate) {\n      console.warn('[TRANSFORM] Missing dates for session:', session);\n      continue; // Skip cette session\n    }\n\n    output.push({\n      json: {\n        stay_slug: staySlug,\n        start_date: startDate,\n        end_date: endDate,\n        seats_left: session.seats_left ?? session.places_restantes ?? session.placesRestantes ?? null,\n        city_departure: session.city_departure ?? session.ville_depart ?? session.villeDepart ?? null,\n        price: session.price ?? session.tarif ?? session.prix ?? null,\n        age_min: session.age_min ?? session.ageMin ?? null,\n        age_max: session.age_max ?? session.ageMax ?? null,\n        import_batch_ts: new Date().toISOString()\n      }\n    });\n  }\n}\n\nif (output.length === 0) {\n  console.warn('[TRANSFORM] No sessions produced. Check input data.');\n}\n\nreturn output;"
      },
      "notesInFlow": true,
      "notes": "Transforme sessions_json en lignes individuelles pour gd_stay_sessions.\n\nSupport:\n- sessions_json comme string JSON\n- sessions_json comme array\n- sessions_json comme object unique\n\nAliases de champs supportés:\n- date_debut/dateDebut → start_date\n- date_fin/dateFin → end_date\n- places_restantes/placesRestantes → seats_left\n- ville_depart/villeDepart → city_departure\n- tarif/prix → price\n\nSessions sans dates sont skippées avec warning."
    },
    {
      "order": 4,
      "name": "HTTP__UPSERT_GD_STAY_SESSIONS",
      "type": "n8n-nodes-base.httpRequest",
      "displayName": "HTTP - Upsert gd_stay_sessions",
      "position": [1400, 300],
      "parameters": {
        "method": "POST",
        "url": "={{ $credentials.supabase?.host || 'https://iirfvndgzutbxwfdwawu.supabase.co' }}/rest/v1/gd_stay_sessions",
        "authentication": "genericCredentialType",
        "genericAuthType": "supabaseApi",
        "sendBody": true,
        "bodyParameters": {
          "parameters": []
        },
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $credentials.supabase?.serviceRoleKey || $credentials.Supabase?.serviceRoleKey }}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{ $credentials.supabase?.serviceRoleKey || $credentials.Supabase?.serviceRoleKey }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "resolution=merge-duplicates,return=representation"
            }
          ]
        },
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "on_conflict",
              "value": "stay_slug,start_date,end_date"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $input.all().map(item => ({\n  stay_slug: item.json.stay_slug,\n  start_date: item.json.start_date,\n  end_date: item.json.end_date,\n  seats_left: item.json.seats_left,\n  city_departure: item.json.city_departure,\n  price: item.json.price,\n  age_min: item.json.age_min,\n  age_max: item.json.age_max,\n  import_batch_ts: item.json.import_batch_ts\n})) }}",
        "options": {}
      },
      "notesInFlow": true,
      "notes": "Upsert des sessions dans Supabase table gd_stay_sessions.\n\n- on_conflict=stay_slug,start_date,end_date (composite key)\n- Header Prefer: merge-duplicates (update si existe)\n- Body: Array de sessions\n\nConflit = mise à jour de la session existante (pas de doublons)"
    }
  ],
  "connections": [
    {
      "from": "Enrichissement JSON de Sauvegarder",
      "to": "FILTER__VALID_ITEMS_FOR_DB",
      "type": "main"
    },
    {
      "from": "FILTER__VALID_ITEMS_FOR_DB",
      "to": "HTTP__UPSERT_GD_STAYS",
      "type": "main",
      "output": 0
    },
    {
      "from": "HTTP__UPSERT_GD_STAYS",
      "to": "TRANSFORM__SESSIONS_TO_ROWS",
      "type": "main"
    },
    {
      "from": "TRANSFORM__SESSIONS_TO_ROWS",
      "to": "HTTP__UPSERT_GD_STAY_SESSIONS",
      "type": "main"
    }
  ],
  "importantNote": "IMPORTANT: Conserver la connexion existante [Enrichissement JSON de Sauvegarder] → [Notifier Fin] pour ne pas briser l'export JSON actuel.",
  "validationChecklist": [
    "Les 4 nœuds sont ajoutés après 'Enrichissement JSON de Sauvegarder'",
    "Le credential Supabase est correctement configuré dans n8n",
    "La sortie TRUE du FILTER va vers HTTP__UPSERT_GD_STAYS",
    "Les 2 nœuds HTTP ont le bon header 'Prefer: resolution=merge-duplicates,return=representation'",
    "L'ancienne connexion vers 'Notifier Fin' est préservée",
    "Sauvegarder le workflow après ajout",
    "Tester en mode manuel (Execute Workflow)"
  ],
  "rollbackProcedure": "En cas de problème : Désactiver (toggle OFF) les 4 nouveaux nœuds → Sauvegarder → Le workflow revient au comportement initial (JSON export uniquement)"
}
